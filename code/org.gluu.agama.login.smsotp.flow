// Start subflow for user otp code validation
Flow org.gluu.agama.login.smsotp
     Basepath ""
     Inputs validationService username phone
// Log flow imputs provided by the flow caller.
Log "@info Information received from the caller: " username phone
otpValidationResult = false
otpUiFeedback.infoMessage = "An OTP code has been send to you on your mobile phone."
otpUiFeedback.errorMessage = ""
otpUiFeedback = {}
maxSMS = Repeat 4 times max
     //  Show UI to collect OTP code from user.
     otpCreds = RRF "smsOtp.ftlh" otpValidationResult
     When otpCreds.hasRequestedNewCode is "yes"
          // Log new code request
          Log "@info User has requested a new code."
          // Resend otp
          resendHasSucceed = Call validationService sendOTPCode username phone
          When resendHasSucceed is null
               Log "@ " __________
          Log "@ " __________
     Otherwise
          //  Add log entry with collected code in log file.
          Log "@info Information provided by the user is : " otpCreds.code
          //  Validate the OTP code provided by the user.
          otpValidationResult = Call validationService validateOTPCode phone otpCreds.code
          // Add log entry withvalidation result in log file.
          Log "@info OTP validation result is:" otpValidationResult
// "OTP verification loop completed"
Log "@info OTP verification loop completed"
it_otpmax = { success: false, error: "ExceededTheNumberOfAttemptsAllowed" }
// SMS OTP error
Finish it_otpmax